start:
  remember count = 0
  // TODO: conversation is triggered by a message from a user who says they need an esim
  // TODO Bitpart interprets incoming language. Response is in the same language
  // TODO check if the user has contacted this line before
  do user = true // FIXME based on above todo

  say "Thank you for contacting [name]. We help people in conflict zones get e-sims for free. We only provide eSIMs for people in certain locations.
  \nWe use an automated messaging system so you can get quicker responses, but you can always reach a human."

  goto menu_step

menu_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "Menu
    \nWhat would you like to do?
    \n1) Get an eSIM for myself
    \n2) Get help with my eSIM
    \n3) Get eSIMs for my community
    \n4) My data rights
    \n5) About us
    \n\nEnter the number"
  hold

  // TODO do we need a "top up" option for existing eSIMs?

  if (event == 1) {
    goto get_esim_1_step
  } else if (event == 2) {
    goto help_step
  } else if (event == 3) {
    // FIXME
  } else if (event == 4) {
    // FIXME
  }

get_esim_1_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "STEP 1:
    \nFirst, you need to make sure that your phone is compatible.
    \nTo do this, please go to your phone's Settings > Connections or SIM Manager. If your device is eSIM compatible you should be able to see if you have the option to add an eSIM.
    \nAlternatively open your phone app, dial *#06# and press the call button. If your device is eSIM compatible you should be able to see an EID number.
    \nIs your device e-sim compatible? Reply with Yes or No"
  hold

  if (event.to_lowercase() == "yes") {
    goto get_esim_2_step
  } else if (event.to_lowercase() == "no") {
    say "Sorry, an eSIM won't work for your device."
    // TODO do we want to add a follow up from admin?
    goto end
  } else {
    set count += 1
    goto get_esim_1_step
  }

get_esim_2_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "Step 2:
    \nWhich networks are available where you are?
    \nTo find out, go to Settings > Local SIM Settings > Network Selection > Toggle Automatic Network Selection
    \n\nWhich of the following networks do you see?
    \n[locations]
    \n\nList all networks available separated by a comma  e.g. :
1,2,5"
  hold

  remember locations = event

  goto get_esim_3_step

get_esim_3_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "Step 3:
    \nA code will follow with you unique eSIM.
    \nHere are the instructions for it to work:
    \n[activationInstructions]
    \n\nIf you can't get it to work, reply with 'Help'"
  hold

  // TODO send unique code

  if (event.to_lowercase() == "help") {
    goto help_step
  } else {
    set count += 1
    goto menu_step
  }

help_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "Help
    \n1) How to activate an e-sim
    \n2) My e-sim isn't working
    \n3) Delete my eSIM
    \n4) Other"
  hold

  if (event == 1) {
    say "eSIM Activation
      \n\n[activationInstructions]"
    
    goto follow_up_step
  } else if (event == 2) {
    say "eSIM Troubleshooting
      \n\n[helpInstructions]"

    goto follow_up_step
  } else if (event == 3) {
    say "DELETE eSIM
    \n\nStep 1: Open your phone's Settings.
    \n2. Tap on 'Connections' (Android)
    \n3. Then, choose 'SIM card manager.'
    \n4. Pick the eSIM plan you want to delete.
    \n5. Turn off the eSIM by toggling the switch. Finally, tap on 'Remove.'"
    
    goto follow_up_step
  } else if (event == 4) {
    goto human_support_step
  } else { 
    say "Sorry, I did not get that."
    set count += 1
    goto help_step
  }

follow_up_step:
  say "What would you like to do now?
      \nReply with 'help' to go back to the help menu
      \nReply with 'human' to get more support
      \nReply with 'end' to end this chat for today."
    hold

    if (event.to_lowercase() == "help") {
      goto help_step
    } else if (event.to_lowercase() == "human") {
      goto human_support_step
    } else if (event.to_lowercase() == "end") {
      say "Thanks for using this service, we hope your eSIM helps."
      
      goto end
    } else {
      say "Sorry, I did not get that."
      set count += 1
      goto help_step
    }

human_support_step:
  say "We've understood that you have a question not covered in the Help section.
    \nPlease share what you need help with."
  hold

  remember problem = event
  // TODO flag relevant data to bitpart

  say "Thank you. An admin will continue this conversation. Please note that it might take some time for them to get in touch."

  goto end

/*******************************************************/
/* unused steps */

first_time_user_step:
  if (count >= 3) {
    goto human_support_step
  }
  
  say "Do you currently have an e-sim? Reply with yes or no."
  hold

  if (event.to_lowercase() == "yes") {
    goto esim_number_step
  } else if (event.to_lowercase() == "no") {

  } else {
    say "Sorry, I did not get that."
    set count += 1
    goto first_time_user_step
  }

esim_number_step:
  if (count >= 3) {
    goto human_support_step
  }
  
  say "What's your e-sim number?
    \n[Instructions on how to find it]
    \nWe'll save this number in our system, so you can top up now and send reminders to top up in the future. You can delete this at any time from your profile.
    \nEnter your e-sim number or reply with 'none' if you do not know it."
  hold

  //TODO what is the regex for an e-sim number?

  if (event.to_lowercase() == "FIXME esim number") {
    say "Thank you!"
    goto menu_step
  } else if (event.to_lowercase() == "none") {
    goto get_esim_1_step
  } else {
    say "Sorry, I did not get that."
    set count += 1
    goto esim_number_step
  }

  refill_step:
  if (count >= 3) {
    goto human_support_step
  }

  say "Can you please confirm that this is your e-sim number? Reply with yes or no.
    \n[e-sim number]
    \n[Instructions on how ï»¿to find it]"
  hold

  if (event.to_lowercase() == "yes") {
    goto refill_amounts_step
  } else if (event.to_lowercase() == "no") {
    goto esim_number_step
  } else {
    set count += 1
    goto refill_step
  }
  
refill_amounts_step:
  say "We currently have the following top-up options available:
    \n1) 1 week / 3GB
    \n2) month / 10GB
    \nPlease reply with the number of your desired top-up validity"
  
  if (event == 1 || event == 3) {
    // TODO refill e-sim with desired amount
  } else if (event == 2 || event == 10) {
    // TODO refill e-sim with desired amount
  }

  say "Your e-sim has been topped up."

  // TODO how to follow up based on how much data/time is left?
